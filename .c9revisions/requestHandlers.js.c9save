{"ts":1347800058548,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var querystring = require(\"querystring\"),\r\n    fs = require(\"fs\"),\r\n    mongo = require('mongoskin'),\r\n    formidable = require(\"formidable\"),\r\n    CountryProvider = require('./countryprovider').CountryProvider;\r\n\r\n\r\nfunction start(response) {\r\n  console.log(\"Request handler 'start' was called.\");\r\n\r\n  var body = '<html>'+\r\n    '<head>'+\r\n    '<meta http-equiv=\"Content-Type\" '+\r\n    'content=\"text/html; charset=UTF-8\" />'+\r\n    '</head>'+\r\n    '<body>'+\r\n    '<form action=\"/upload\" enctype=\"multipart/form-data\" '+\r\n    'method=\"post\">'+\r\n    '<input type=\"file\" name=\"upload\" multiple=\"multiple\">'+\r\n    '<input type=\"submit\" value=\"Upload file\" />'+\r\n    '</form>'+\r\n    '</body>'+\r\n    '</html>';\r\n\r\n    response.writeHead(200, {\"Content-Type\": \"text/html\"});\r\n    response.write(body);\r\n    response.end();\r\n}\r\n\r\nfunction upload(response, request) {\r\n  console.log(\"Request handler 'upload' was called.\");\r\n\r\n  var form = new formidable.IncomingForm();\r\n  console.log(\"about to parse\");\r\n  form.parse(request, function(error, fields, files) {\r\n    console.log(\"parsing done\");\r\n\r\n    /* Possible error on Windows systems:\r\n       tried to rename to an already existing file */\r\n    fs.rename(files.upload.path, \"./tmp/test.png\", function(err) {\r\n      if (err) {\r\n        fs.unlink(\"./tmp/test.png\");\r\n        fs.rename(files.upload.path, \"./tmp/test.png\");\r\n      }\r\n    });\r\n    response.writeHead(200, {\"Content-Type\": \"text/html\"});\r\n    response.write(\"received image:<br/>\");\r\n    response.write(\"<img src='/show' />\");\r\n    response.end();\r\n  });\r\n}\r\n\r\nvar countryProvider = new CountryProvider();\r\n\r\nfunction mongotest(response, request){\r\n    countryProvider.findAll(function(error, docs){\r\n        res.send(docs);\r\n    });\r\n\r\n\r\n    //var conn = mongo.db('oyaaraas:bris@alex.mongohq.com:10083/mytestdb');\r\n    //var conn = mongo.db('imbringing:sexyback@rose.mongohq.com:10029/blackbook');\r\n\r\n    \r\n//    conn.collection('companies').find({country:'Norway'}).toArray(function(err, items){\r\n//        if(err) {\r\n//            console.log(err);\r\n//            throw err;\r\n//        }\r\n//            res.writeHead(200, {'Content-Type': 'text/plain'});\r\n//            res.end(JSON.stringify(items));\r\n//    })\r\n    \r\n}\r\n\r\nfunction show(response) {\r\n  console.log(\"Request handler 'show' was called.\");\r\n  fs.readFile(\"./tmp/test.png\", \"binary\", function(error, file) {\r\n    if(error) {\r\n      response.writeHead(500, {\"Content-Type\": \"text/plain\"});\r\n      response.write(error + \"\\n\");\r\n      response.end();\r\n    } else {\r\n      response.writeHead(200, {\"Content-Type\": \"image/png\"});\r\n      response.write(file, \"binary\");\r\n      response.end();\r\n    }\r\n  });\r\n}\r\n\r\nexports.start = start;\r\nexports.upload = upload;\r\nexports.show = show;\r\nexports.mongotest = mongotest;"]],"start1":0,"start2":0,"length1":0,"length2":2784}]],"length":2784}
